<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registrar Venta - ZAPATONGT</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="js/supabase-client.js"></script>
  <link rel="stylesheet" href="assets/style.css">
  <script src="js/auth.js"></script>
</head>
<body>
  <div id="header"></div>

  <!-- Filtros y cliente -->
  <div id="filtros-container">
    <select id="cliente-select"></select>

    <input list="codigos" type="text" id="filtroCodigo" placeholder="üîç C√≥digo">
    <datalist id="codigos"></datalist>

    <input list="nombres" type="text" id="filtroNombre" placeholder="üëü Nombre">
    <datalist id="nombres"></datalist>

    <div class="filtro-botones">
      <span>üè∑Ô∏è Marca:</span>
      <div id="marcas-botones" class="grupo-botones"></div>
    </div>

    <div class="filtro-botones">
      <span>üìè Talla:</span>
      <div id="tallas-botones" class="grupo-botones"></div>
    </div>

    <button onclick="filtrarProductos()">Buscar</button>
    <button onclick="limpiarFiltros()">Limpiar</button>
  </div>

  <p id="contador-resultados"></p>

  <!-- Tarjetas de productos -->
  <div id="productos-container" class="grid-contenedor"></div>

  <!-- Carrito de venta -->
  <h2>üõí Carrito de Venta</h2>
  <table id="carrito-table">
    <thead>
      <tr>
        <th>C√≥digo</th>
        <th>Nombre</th>
        <th>Talla</th>
        <th>Cantidad</th>
        <th>Precio</th>
        <th>Subtotal</th>
        <th>Quitar</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p id="total-carrito">Total productos: Q 0.00</p>

  <div class="venta-opciones">
    <div class="campo-form">
      <label for="fecha-venta">üóìÔ∏è Fecha de la venta:</label>
      <input type="date" id="fecha-venta">
    </div>
    <div class="campo-form">
      <label for="total-final">üí≥ Total final (Q):</label>
      <input type="number" id="total-final" min="0" step="0.01">
    </div>
  </div>

  <button onclick="registrarVenta()">‚úÖ Registrar Venta</button>

  <div id="footer"></div>

  <script>
    let productos = [];
    let seleccionados = [];
    let totalFinalManual = false;
    let totalBaseActual = 0;
    const filtrosMarcaSeleccionadas = new Set();
    const filtrosTallaSeleccionadas = new Set();

    const totalFinalInput = document.getElementById('total-final');
    const fechaVentaInput = document.getElementById('fecha-venta');

    if (fechaVentaInput) {
      const hoy = new Date();
      const anio = hoy.getFullYear();
      const mes = String(hoy.getMonth() + 1).padStart(2, '0');
      const dia = String(hoy.getDate()).padStart(2, '0');
      fechaVentaInput.value = `${anio}-${mes}-${dia}`;
    }

    if (totalFinalInput) {
      totalFinalInput.value = '0.00';
      totalFinalInput.addEventListener('input', () => {
        totalFinalManual = totalFinalInput.value.trim() !== '';
      });
      totalFinalInput.addEventListener('blur', () => {
        if (totalFinalInput.value.trim() === '') {
          totalFinalManual = false;
          totalFinalInput.value = totalBaseActual.toFixed(2);
        }
      });
    }

    (async () => {
      const sesion = await portalAuth.asegurarSesionActiva();
      if (!sesion) return;

      document.getElementById("header").innerHTML = await fetch('header.html').then(r => r.text());
      portalAuth.refrescarIndicadoresSesion();
      document.getElementById("footer").innerHTML = await fetch('footer.html').then(r => r.text());
      await cargarClientes();
      await cargarProductos();
    })();

    async function cargarClientes() {
      const { data, error } = await supabase
        .from('CLIENTE')
        .select('*')
        .order('nombre', { ascending: true });

      if (error) return alert('Error cargando clientes');
      const select = document.getElementById('cliente-select');
      select.innerHTML = '<option value="">Seleccione cliente</option>';
      data.forEach(cliente => {
        const option = document.createElement('option');
        option.value = cliente.id;
        option.textContent = cliente.nombre;
        select.appendChild(option);
      });
    }

    async function cargarProductos() {
      const { data, error } = await supabase.from('INVENTARIO').select('*').gt('disponible', 0);
      if (error) return alert('Error cargando productos');
      productos = data;
      llenarDatalists(data);
      filtrarProductos();
    }

    function filtrarProductos() {
      const codigo = document.getElementById('filtroCodigo').value.trim().toLowerCase();
      const nombre = document.getElementById('filtroNombre').value.trim().toLowerCase();
      const marcasSeleccionadas = Array.from(filtrosMarcaSeleccionadas).map(m => m.trim().toLowerCase()).filter(Boolean);
      const tallasSeleccionadas = Array.from(filtrosTallaSeleccionadas).map(t => t.trim()).filter(Boolean);

      let filtrados = productos;
      if (codigo) filtrados = filtrados.filter(p => p.codigo.toLowerCase().includes(codigo));
      if (nombre) filtrados = filtrados.filter(p => p.nombre.toLowerCase().includes(nombre));
      if (marcasSeleccionadas.length) {
        filtrados = filtrados.filter(p => {
          const marcaNormalizada = (p.marca ?? '').toString().trim().toLowerCase();
          return marcasSeleccionadas.includes(marcaNormalizada);
        });
      }
      if (tallasSeleccionadas.length) {
        filtrados = filtrados.filter(p => {
          const tallaNormalizada = String(p.talla ?? '').trim();
          return tallasSeleccionadas.includes(tallaNormalizada);
        });
      }

      mostrarProductos(filtrados);
    }

    function mostrarProductos(productosFiltrados) {
      const contenedor = document.getElementById('productos-container');
      contenedor.innerHTML = '';
      document.getElementById("contador-resultados").textContent = `Mostrando ${productosFiltrados.length} tallas`;

      const agrupado = {};
      productosFiltrados.forEach(item => {
        if (!agrupado[item.codigo]) agrupado[item.codigo] = [];
        agrupado[item.codigo].push(item);
      });

      for (const [codigo, items] of Object.entries(agrupado)) {
        const producto = items[0];
        const div = document.createElement('div');
        div.className = 'card';

        const opcionesTalla = items
          .filter(i => i.disponible > 0)
          .sort((a, b) => parseFloat(a.talla) - parseFloat(b.talla))
          .map(i => `<option value="${i.id}" data-disponible="${i.disponible}" data-precio="${i.precio}" data-talla="${i.talla}">Talla ${i.talla} - ${i.disponible} disp.</option>`)
          .join('');

        div.innerHTML = `
          <div class="card-inner">
            <div class="card-front">
              <img class="producto-img" src="${producto.imagen_url}" alt="Zapato">
            </div>
            <div class="card-back">
              <div class="info-back">
                <h3>${producto.nombre} - ${producto.codigo}</h3>
                <p>${producto.marca}</p>
                <p>Q ${producto.precio.toFixed(2)}</p>
                <label>Talla:
                  <select id="select-talla-${codigo}">${opcionesTalla}</select>
                </label>
                <input type="number" id="cantidad-${codigo}" placeholder="Cantidad" min="1">
                <button onclick="agregarProducto('${codigo}')">Agregar a venta</button>
              </div>
            </div>
          </div>
        `;
        contenedor.appendChild(div);
      }
    }

    function agregarProducto(codigo) {
      const select = document.getElementById(`select-talla-${codigo}`);
      const input = document.getElementById(`cantidad-${codigo}`);
      const productoId = parseInt(select.value);
      const disponible = parseInt(select.selectedOptions[0].dataset.disponible);
      const precio = parseFloat(select.selectedOptions[0].dataset.precio);
      const talla = select.selectedOptions[0].dataset.talla;
      const cantidad = parseInt(input.value);

      if (!cantidad || cantidad < 1) {
        return alert('Cantidad inv√°lida');
      }

      const yaAgregados = seleccionados
        .filter(p => p.productoId === productoId)
        .reduce((suma, p) => suma + p.cantidad, 0);

      if ((yaAgregados + cantidad) > disponible) {
        return alert(`Ya tienes ${yaAgregados} en el carrito. Solo puedes agregar ${disponible - yaAgregados} m√°s.`);
      }

      const existente = seleccionados.find(p => p.productoId === productoId);

      if (existente) {
        existente.cantidad += cantidad;
        existente.subtotal = existente.cantidad * existente.precio;
      } else {
        seleccionados.push({
          productoId,
          cantidad,
          precio,
          subtotal: precio * cantidad,
          talla,
          codigo
        });
      }

      input.value = '';
      actualizarCarrito();
      alert(`Agregado: ${codigo} - Talla ${talla} x${cantidad}`);
    }

    function actualizarCarrito() {
      const tbody = document.querySelector('#carrito-table tbody');
      tbody.innerHTML = '';

      let total = 0;

      seleccionados.forEach((item, index) => {
        const producto = productos.find(p => p.id === item.productoId);
        total += item.subtotal;

        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>${item.codigo}</td>
          <td>${producto.nombre}</td>
          <td>${item.talla}</td>
          <td>${item.cantidad}</td>
          <td>Q ${item.precio.toFixed(2)}</td>
          <td>Q ${item.subtotal.toFixed(2)}</td>
          <td><button onclick="quitarDelCarrito(${index})">üóëÔ∏è</button></td>
        `;
        tbody.appendChild(fila);
      });

      const totalRedondeado = Number(total.toFixed(2));
      totalBaseActual = totalRedondeado;
      document.getElementById('total-carrito').textContent = `Total productos: Q ${totalRedondeado.toFixed(2)}`;

      if (!totalFinalInput) return;

      if (seleccionados.length === 0) {
        totalFinalManual = false;
        totalBaseActual = 0;
        totalFinalInput.value = '0.00';
        return;
      }

      if (!totalFinalManual) {
        totalFinalInput.value = totalRedondeado.toFixed(2);
      }
    }

    function quitarDelCarrito(index) {
      seleccionados.splice(index, 1);
      actualizarCarrito();
    }

    async function registrarVenta() {
      const clienteId = parseInt(document.getElementById('cliente-select').value);
      if (!clienteId) return alert('Selecciona un cliente');
      if (seleccionados.length === 0) return alert('No se agregaron productos');

      const totalBase = Number(seleccionados.reduce((s, d) => s + d.subtotal, 0).toFixed(2));

      if (!totalFinalInput) return alert('No se encontr√≥ el campo de total final');

      const totalFinal = Number(totalFinalInput.value);
      if (!Number.isFinite(totalFinal) || totalFinal <= 0) {
        return alert('Ingresa un total final v√°lido');
      }

      const totalFinalRedondeado = Number(totalFinal.toFixed(2));
      const ajuste = Number((totalFinalRedondeado - totalBase).toFixed(2));

      if (!fechaVentaInput) return alert('No se encontr√≥ el campo de fecha');
      const fechaSeleccionada = fechaVentaInput.value;
      if (!fechaSeleccionada) {
        return alert('Selecciona la fecha de la venta');
      }

      const partesFecha = fechaSeleccionada.split('-').map(Number);
      if (partesFecha.length !== 3 || partesFecha.some(n => !Number.isFinite(n))) {
        return alert('Fecha de venta inv√°lida');
      }

      const [anio, mes, dia] = partesFecha;
      if (!anio || !mes || !dia) {
        return alert('Fecha de venta inv√°lida');
      }
      const ahora = new Date();
      const fechaVenta = new Date(anio, mes - 1, dia, ahora.getHours(), ahora.getMinutes(), ahora.getSeconds(), ahora.getMilliseconds());
      const fechaVentaIso = fechaVenta.toISOString();

      const { data: venta, error: errorVenta } = await supabase
        .from('VENTAS')
        .insert([{ cliente_id: clienteId, total: totalFinalRedondeado, ajuste, created_at: fechaVentaIso }])
        .select()
        .single();

      if (errorVenta) return alert('Error al registrar venta');

      for (const d of seleccionados) {
        const inventarioActual = productos.find(p => p.id === d.productoId);
        if (!inventarioActual || d.cantidad > inventarioActual.disponible) {
          return alert(`El producto ${d.codigo} (Talla ${d.talla}) ya no tiene suficiente inventario.`);
        }
      }

      for (const d of seleccionados) {
        await supabase.from('DETALLE_VENTAS').insert([{
          venta_id: venta.id,
          producto_id: d.productoId,
          cantidad: d.cantidad,
          precio_unitario: d.precio,
          descuento: 0,
          subtotal: d.subtotal
        }]);

        await supabase.from('INVENTARIO').update({
          disponible: productos.find(p => p.id === d.productoId).disponible - d.cantidad
        }).eq('id', d.productoId);
      }

      await supabase.from('VENTAS').update({ total: totalFinalRedondeado, ajuste }).eq('id', venta.id);
      alert('Venta registrada con √©xito');
      location.reload();
    }

    function limpiarFiltros() {
      ['filtroCodigo', 'filtroNombre'].forEach(id => {
        document.getElementById(id).value = '';
      });
      filtrosMarcaSeleccionadas.clear();
      filtrosTallaSeleccionadas.clear();
      actualizarBotones('marcas-botones', filtrosMarcaSeleccionadas);
      actualizarBotones('tallas-botones', filtrosTallaSeleccionadas);
      filtrarProductos();
    }

    function llenarDatalists(data) {
      const codigos = [...new Set(data.map(i => i.codigo))];
      const nombres = [...new Set(data.map(i => i.nombre))];
      const marcas = [...new Set(data.map(i => i.marca))];
      const tallas = [...new Set(data.map(i => i.talla))];

      const setDatalist = (id, values) => {
        const list = document.getElementById(id);
        list.innerHTML = '';
        values.forEach(v => {
          const option = document.createElement('option');
          option.value = v;
          list.appendChild(option);
        });
      };

      setDatalist('codigos', codigos);
      setDatalist('nombres', nombres);
      crearBotonesFiltro('marcas-botones', [...marcas].sort((a, b) => a.localeCompare(b)), 'marca');
      crearBotonesFiltro(
        'tallas-botones',
        [...tallas].sort((a, b) => {
          const numA = parseFloat(a);
          const numB = parseFloat(b);
          if (!Number.isNaN(numA) && !Number.isNaN(numB)) return numA - numB;
          return a.localeCompare(b);
        }),
        'talla'
      );
    }

    function crearBotonesFiltro(containerId, valores, tipo) {
      const contenedor = document.getElementById(containerId);
      if (!contenedor) return;
      contenedor.innerHTML = '';

      valores.forEach(valor => {
        const boton = document.createElement('button');
        boton.type = 'button';
        boton.className = 'boton-filtro';
        boton.dataset.valor = valor;
        boton.textContent = valor;
        boton.addEventListener('click', () => {
          const conjunto = tipo === 'marca' ? filtrosMarcaSeleccionadas : filtrosTallaSeleccionadas;
          if (conjunto.has(valor)) {
            conjunto.delete(valor);
          } else {
            conjunto.add(valor);
          }
          actualizarBotones(containerId, conjunto);
          filtrarProductos();
        });
        contenedor.appendChild(boton);
      });

      const conjunto = tipo === 'marca' ? filtrosMarcaSeleccionadas : filtrosTallaSeleccionadas;
      actualizarBotones(containerId, conjunto);
    }

    function actualizarBotones(containerId, valoresSeleccionados) {
      const contenedor = document.getElementById(containerId);
      if (!contenedor) return;
      contenedor.querySelectorAll('button').forEach(boton => {
        const activo = valoresSeleccionados instanceof Set
          ? valoresSeleccionados.has(boton.dataset.valor)
          : valoresSeleccionados === boton.dataset.valor;
        boton.classList.toggle('activo', activo);
      });
    }
  </script>
</body>
</html>
