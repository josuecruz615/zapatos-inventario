<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inventario - ZAPATONGT</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="js/supabase-client.js"></script>
  <script src="js/auth.js"></script>
  <link rel="stylesheet" href="assets/style.css">
  <style>
    #modal-progreso {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: #fff;
      font-size: 1.2em;
    }
    #barra-progreso {
      width: 80%;
      height: 20px;
      background: #555;
      margin-top: 20px;
      border-radius: 10px;
      overflow: hidden;
    }
    #barra-progreso div {
      height: 100%;
      width: 0%;
      background: #4caf50;
      transition: width 0.2s ease;
    }
  </style>
</head>
<body>
  <div id="header"></div>

  <!-- Filtros de b√∫squeda -->
  <div id="filtros-container">
    <input list="codigos" type="text" id="filtroCodigo" placeholder="üîç C√≥digo">
    <datalist id="codigos"></datalist>

    <input list="nombres" type="text" id="filtroNombre" placeholder="üëü Nombre">
    <datalist id="nombres"></datalist>

    <input type="number" id="filtroCantidad" min="0" step="1" placeholder="üî¢ Cantidad total">

    <div class="filtro-botones">
      <span>üè∑Ô∏è Marca:</span>
      <div id="marcas-botones" class="grupo-botones"></div>
    </div>

    <div class="filtro-botones">
      <span>üìè Talla:</span>
      <div id="tallas-botones" class="grupo-botones"></div>
    </div>

    <select id="filtroDisponible">
      <option value="disponibles" selected>‚úîÔ∏è DISPONIBLES</option>
      <option value="todos">üì¶ TODOS</option>
    </select>

    <button onclick="cargarInventario()">Buscar</button>
    <button onclick="limpiarFiltros()">Limpiar</button>
    <button onclick="descargarImagenes()">Descargar Im√°genes</button>
  </div>

  <div id="modal-progreso">
    <p id="texto-progreso">Preparando...</p>
    <div id="barra-progreso"><div></div></div>
  </div>

  <p id="contador-resultados"></p>
  <div id="inventario-contenedor" class="grid-contenedor">
    <p>Usa los filtros y haz clic en "Buscar" para ver los productos.</p>
  </div>

  <div id="footer"></div>

  <script>
    let inventarioCompleto = [];
    const filtrosMarcaSeleccionadas = new Set();
    const filtrosTallaSeleccionadas = new Set();

    (async () => {
      const sesion = await portalAuth.asegurarSesionActiva();
      if (!sesion) return;

      document.getElementById("header").innerHTML = await fetch('header.html').then(r => r.text());
      portalAuth.refrescarIndicadoresSesion();
      document.getElementById("footer").innerHTML = await fetch('footer.html').then(r => r.text());

      await obtenerInventario();
      cargarInventario();
    })();

    async function obtenerInventario() {
      let desde = 0;
      const tamanoPagina = 1000;
      inventarioCompleto = [];
      let sigue = true;

      while (sigue) {
        const { data, error } = await supabase
          .from('INVENTARIO')
          .select('id, codigo, nombre, marca, talla, disponible, precio, imagen_url')
          .range(desde, desde + tamanoPagina - 1);

        if (error) {
          alert('Error al cargar inventario');
          console.error(error);
          break;
        }

        inventarioCompleto = inventarioCompleto.concat(data);
        console.log(`Cargados ${inventarioCompleto.length} productos`);

        if (data.length < tamanoPagina) sigue = false;
        else desde += tamanoPagina;
      }

      llenarDatalists(inventarioCompleto);
    }

    function cargarInventario() {
      const codigo = document.getElementById('filtroCodigo').value.trim().toLowerCase();
      const nombre = document.getElementById('filtroNombre').value.trim().toLowerCase();
      const marcasSeleccionadas = Array.from(filtrosMarcaSeleccionadas);
      const tallasSeleccionadas = Array.from(filtrosTallaSeleccionadas);
      const disponibleFiltro = document.getElementById('filtroDisponible').value;
      const cantidadFiltroValor = document.getElementById('filtroCantidad').value.trim();

      let resultados = inventarioCompleto;
      if (codigo) resultados = resultados.filter(p => p.codigo.toLowerCase().includes(codigo));
      if (nombre) resultados = resultados.filter(p => p.nombre.toLowerCase().includes(nombre));
      if (marcasSeleccionadas.length) {
        resultados = resultados.filter(p => {
          const marcaNormalizada = (p.marca ?? '').toString().trim().toLowerCase();
          return marcasSeleccionadas.includes(marcaNormalizada);
        });
      }
      if (tallasSeleccionadas.length) {
        resultados = resultados.filter(p => {
          const tallaNormalizada = String(p.talla ?? '').trim();
          return tallasSeleccionadas.includes(tallaNormalizada);
        });
      }
      if (disponibleFiltro === 'disponibles') {
        resultados = resultados.filter(p => p.disponible > 0);
      }

      if (cantidadFiltroValor !== '') {
        const cantidadFiltroNumero = Number(cantidadFiltroValor);
        if (!Number.isNaN(cantidadFiltroNumero)) {
          const totalesPorCodigo = resultados.reduce((acc, item) => {
            const codigo = item.codigo;
            const disponible = Number(item.disponible) || 0;
            acc[codigo] = (acc[codigo] || 0) + disponible;
            return acc;
          }, {});
          resultados = resultados.filter(item => totalesPorCodigo[item.codigo] === cantidadFiltroNumero);
        }
      }

      const agrupado = {};
      resultados.forEach(item => {
        if (!agrupado[item.codigo]) agrupado[item.codigo] = [];
        agrupado[item.codigo].push(item);
      });

      const contenedor = document.getElementById('inventario-contenedor');
      contenedor.innerHTML = '';

      if (resultados.length === 0) {
        contenedor.innerHTML = '<p>No se encontraron productos con esos filtros.</p>';
        document.getElementById("contador-resultados").textContent = '';
        return;
      }

      document.getElementById("contador-resultados").textContent =
        `Mostrando ${Object.keys(agrupado).length} productos distintos.`;

      for (const [codigo, items] of Object.entries(agrupado)) {
        const producto = items[0];
        const div = document.createElement('div');
        div.className = 'card';

        items.sort((a, b) => parseFloat(a.talla) - parseFloat(b.talla));

        const filas = items.map(i => {
          const etiqueta = i.disponible > 5
            ? '<span class="disponible-label verde">‚úîÔ∏è</span>'
            : i.disponible > 0
            ? '<span class="disponible-label amarillo">‚ö†Ô∏è</span>'
            : '<span class="disponible-label rojo">‚ùå</span>';
          return `<tr><td>${i.talla}</td><td>${etiqueta}${i.disponible}</td></tr>`;
        }).join('');

        div.innerHTML = `
          <div class="card-inner">
            <div class="card-front">
              <img class="producto-img" src="${producto.imagen_url}" alt="Zapato">
            </div>
            <div class="card-back">
              <div class="info-back">
                <h3>${producto.nombre} - ${producto.codigo}</h3>
                <p>${producto.marca}</p>
                <p>Q ${producto.precio.toFixed(2)}</p>
                <table class="talla-lista">
                  <thead><tr><th>Talla</th><th>Disponible</th></tr></thead>
                  <tbody>${filas}</tbody>
                </table>
              </div>
            </div>
          </div>`;
        contenedor.appendChild(div);
      }
    }

    function llenarDatalists(data) {
      const codigos = [...new Set(data.map(i => i.codigo))];
      const nombres = [...new Set(data.map(i => i.nombre))];
      const marcas = new Set(data.map(i => i.marca));
      const tallas = new Set(data.map(i => i.talla));
      const setDatalist = (id, values) => {
        const list = document.getElementById(id);
        list.innerHTML = '';
        values.forEach(v => {
          const option = document.createElement('option');
          option.value = v;
          list.appendChild(option);
        });
      };
      setDatalist('codigos', codigos);
      setDatalist('nombres', nombres);
      crearBotonesFiltro('marcas-botones', [...marcas]
        .filter(v => v != null && String(v).trim() !== '')
        .map(v => String(v))
        .sort((a, b) => a.localeCompare(b)), 'marca');
      crearBotonesFiltro('tallas-botones', [...tallas]
        .filter(v => v != null && String(v).trim() !== '')
        .map(v => String(v))
        .sort((a, b) => {
          const numA = parseFloat(a);
          const numB = parseFloat(b);
          if (!Number.isNaN(numA) && !Number.isNaN(numB)) return numA - numB;
          return a.localeCompare(b);
        }), 'talla');
    }

    function limpiarFiltros() {
      ['filtroCodigo', 'filtroNombre', 'filtroCantidad'].forEach(id => {
        document.getElementById(id).value = '';
      });
      document.getElementById('filtroDisponible').value = 'disponibles';
      filtrosMarcaSeleccionadas.clear();
      filtrosTallaSeleccionadas.clear();
      actualizarBotones('marcas-botones', filtrosMarcaSeleccionadas);
      actualizarBotones('tallas-botones', filtrosTallaSeleccionadas);
      cargarInventario();
    }

    function crearBotonesFiltro(containerId, valores, tipo) {
      const contenedor = document.getElementById(containerId);
      if (!contenedor) return;
      contenedor.innerHTML = '';

      valores.forEach(valor => {
        const valorTexto = valor != null ? String(valor) : '';
        const claveNormalizada = tipo === 'marca'
          ? valorTexto.trim().toLowerCase()
          : valorTexto.trim();

        if (!claveNormalizada) return;

        const boton = document.createElement('button');
        boton.type = 'button';
        boton.className = 'boton-filtro';
        boton.dataset.valor = valorTexto;
        boton.dataset.clave = claveNormalizada;
        boton.textContent = valorTexto;
        boton.addEventListener('click', () => {
          const conjunto = tipo === 'marca' ? filtrosMarcaSeleccionadas : filtrosTallaSeleccionadas;
          if (conjunto.has(claveNormalizada)) {
            conjunto.delete(claveNormalizada);
          } else {
            conjunto.add(claveNormalizada);
          }
          actualizarBotones(containerId, conjunto);
          cargarInventario();
        });
        contenedor.appendChild(boton);
      });

      const conjunto = tipo === 'marca' ? filtrosMarcaSeleccionadas : filtrosTallaSeleccionadas;
      actualizarBotones(containerId, conjunto);
    }

    function actualizarBotones(containerId, valoresSeleccionados) {
      const contenedor = document.getElementById(containerId);
      if (!contenedor) return;
      contenedor.querySelectorAll('button').forEach(boton => {
        const claveBoton = boton.dataset.clave ?? boton.dataset.valor ?? '';
        const activo = valoresSeleccionados instanceof Set
          ? valoresSeleccionados.has(claveBoton)
          : valoresSeleccionados === claveBoton;
        boton.classList.toggle('activo', activo);
      });
    }

    async function descargarImagenes() {
      const imagenes = document.querySelectorAll('.producto-img');
      const modal = document.getElementById('modal-progreso');
      const texto = document.getElementById('texto-progreso');
      const barra = document.getElementById('barra-progreso').firstElementChild;

      if (imagenes.length === 0) {
        alert('No hay im√°genes para descargar.');
        return;
      }

      modal.style.display = 'flex';
      texto.textContent = 'Preparando ZIP...';
      barra.style.width = '0%';

      const zip = new JSZip();
      const carpeta = zip.folder('imagenes');

      const fechaActual = new Date();
      const fechaHora = fechaActual.toISOString().replace(/[-:]/g, '').replace(/\..+/, '').replace('T', '-');

      for (let i = 0; i < imagenes.length; i++) {
        const img = imagenes[i];
        const url = img.src;

        texto.textContent = `Descargando imagen ${i + 1} de ${imagenes.length}...`;
        barra.style.width = `${((i + 1) / imagenes.length) * 100}%`;

        const respuesta = await fetch(url);
        const blob = await respuesta.blob();

        const nombreArchivo = `img_${fechaHora}_${i + 1}.jpg`;
        carpeta.file(nombreArchivo, blob);
      }

      texto.textContent = 'Generando ZIP (esto puede tardar un poco)...';
      barra.style.width = '100%';

      const contenidoZip = await zip.generateAsync(
        { type: 'blob', streamFiles: true },
        (metadata) => {
          texto.textContent = `Generando ZIP: ${Math.floor(metadata.percent)}%`;
        }
      );

      const enlaceDescarga = document.createElement('a');
      enlaceDescarga.href = URL.createObjectURL(contenidoZip);
      enlaceDescarga.download = `imagenes_${fechaHora}.zip`;
      document.body.appendChild(enlaceDescarga);
      enlaceDescarga.click();
      document.body.removeChild(enlaceDescarga);

      modal.style.display = 'none';
      alert('¬°Descarga del ZIP iniciada!');
    }
  </script>
</body>
</html>
