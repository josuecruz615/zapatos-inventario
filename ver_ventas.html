<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ventas Realizadas - ZAPATONGT</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="js/supabase-client.js"></script>
  <link rel="stylesheet" href="assets/style.css">
  <script src="js/auth.js"></script>
</head>
<body>
  <div id="header"></div>

  <main class="contenido">
    <h1>üìä Ventas Realizadas</h1>

    <div id="filtros-container">
      <label for="mesFiltro">üìÜ Mes:</label>
      <input type="month" id="mesFiltro">

      <button type="button" onclick="cargarVentas('mes')">üîç Ver mes</button>
      <button type="button" onclick="cargarVentas('anio')">üìÖ Ver a√±o completo</button>
      <button type="button" onclick="cargarVentas('todo')">‚è±Ô∏è Ver historial completo</button>
    </div>

    <table class="tabla-datos">
      <thead>
        <tr>
          <th>üóìÔ∏è Fecha</th>
          <th>üë§ Cliente</th>
          <th>üí∞ Total (Q)</th>
          <th>üì¶ Detalle</th>
        </tr>
      </thead>
      <tbody id="tabla-ventas">
        <tr><td colspan="4">Cargando ventas...</td></tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="2" style="text-align: right;"><strong>Total General:</strong></td>
          <td id="total-general">Q 0.00</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </main>

  <div id="footer"></div>

  <!-- Modal de detalle de venta -->
  <div id="modal-detalle" class="modal oculto">
    <div class="modal-contenido">
      <span class="cerrar" onclick="cerrarModal()">√ó</span>
      <h2>üßæ Detalle de Venta</h2>
      <div id="detalle-contenido"></div>
    </div>
  </div>

  <script>
    (async () => {
      const sesion = await portalAuth.asegurarSesionActiva();
      if (!sesion) return;

      document.getElementById("header").innerHTML = await fetch("header.html").then(r => r.text());
      portalAuth.refrescarIndicadoresSesion();
      document.getElementById("footer").innerHTML = await fetch("footer.html").then(r => r.text());
      cargarVentas('mes');
    })();

    function obtenerMesActual() {
      const hoy = new Date();
      const mes = String(hoy.getMonth() + 1).padStart(2, '0');
      return `${hoy.getFullYear()}-${mes}`;
    }

    function calcularRangoMensual(valorMes) {
      const mesSeleccionado = valorMes || obtenerMesActual();
      const [anio, mes] = mesSeleccionado.split('-');
      const ultimoDia = new Date(parseInt(anio, 10), parseInt(mes, 10), 0).getDate();
      const fechaInicio = `${anio}-${mes}-01T00:00:00`;
      const fechaFin = `${anio}-${mes}-${String(ultimoDia).padStart(2, '0')}T23:59:59.999`;
      return { mesSeleccionado, fechaInicio, fechaFin };
    }

    function calcularRangoAnual(valorMes) {
      const mesSeleccionado = valorMes || obtenerMesActual();
      const [anio] = mesSeleccionado.split('-');
      const fechaInicio = `${anio}-01-01T00:00:00`;
      const fechaFin = `${anio}-12-31T23:59:59.999`;
      return { anio, fechaInicio, fechaFin };
    }

    async function cargarVentas(filtro = 'mes') {
      const tabla = document.getElementById('tabla-ventas');
      tabla.innerHTML = '<tr><td colspan="4">Cargando ventas...</td></tr>';

      const inputMesElemento = document.getElementById('mesFiltro');
      const valorMes = inputMesElemento?.value || obtenerMesActual();

      if (inputMesElemento && !inputMesElemento.value) {
        inputMesElemento.value = valorMes;
      }

      let fechaInicio = null;
      let fechaFin = null;

      if (filtro === 'mes') {
        const rangoMensual = calcularRangoMensual(valorMes);
        fechaInicio = rangoMensual.fechaInicio;
        fechaFin = rangoMensual.fechaFin;
        if (inputMesElemento) {
          inputMesElemento.value = rangoMensual.mesSeleccionado;
        }
      } else if (filtro === 'anio') {
        const rangoAnual = calcularRangoAnual(valorMes);
        fechaInicio = rangoAnual.fechaInicio;
        fechaFin = rangoAnual.fechaFin;
      }

      let query = supabase
        .from('VENTAS')
        .select('*, CLIENTE(nombre)')
        .order('created_at', { ascending: false });

      if (fechaInicio && fechaFin) {
        query = query
          .gte('created_at', fechaInicio)
          .lte('created_at', fechaFin);
      }

      const { data, error } = await query;

      if (error) {
        tabla.innerHTML = `<tr><td colspan="4">‚ùå Error: ${error.message}</td></tr>`;
        document.getElementById("total-general").textContent = "Q 0.00";
        return;
      }

      if (data.length === 0) {
        tabla.innerHTML = '<tr><td colspan="4">No hay ventas en ese rango.</td></tr>';
        document.getElementById("total-general").textContent = "Q 0.00";
        return;
      }

      tabla.innerHTML = '';
      let totalGeneral = 0;

      for (const venta of data) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${new Date(venta.created_at).toLocaleDateString()}</td>
          <td>${venta.CLIENTE?.nombre || 'Sin cliente'}</td>
          <td>Q ${venta.total.toFixed(2)}</td>
          <td><button onclick="verDetalle(${venta.id})">üîç Ver</button></td>
        `;
        tabla.appendChild(row);
        totalGeneral += venta.total;
      }

      document.getElementById("total-general").textContent = `Q ${totalGeneral.toFixed(2)}`;
    }

    async function verDetalle(ventaId) {
      const { data, error } = await supabase
        .from('DETALLE_VENTAS')
        .select('*, INVENTARIO(nombre, talla, imagen_url)')
        .eq('venta_id', ventaId);

      if (error) return alert('Error al cargar detalle');

      if (!data || data.length === 0) {
        document.getElementById("detalle-contenido").innerHTML = '<p>No hay detalle disponible.</p>';
      } else {
        const html = data.map(d => `
          <div class="detalle-item">
            <img src="${d.INVENTARIO.imagen_url}" alt="Producto" class="detalle-img">
            <div class="detalle-info">
              <strong>${d.cantidad} x</strong> ${d.INVENTARIO.nombre}<br>
              Talla: ${d.INVENTARIO.talla}<br>
              Precio: Q${d.precio_unitario.toFixed(2)}<br>
              Subtotal: Q${d.subtotal.toFixed(2)}
            </div>
          </div>
          <hr>
        `).join('');
        document.getElementById("detalle-contenido").innerHTML = html;
      }

      document.getElementById("modal-detalle").classList.remove('oculto');
    }

    function cerrarModal() {
      document.getElementById("modal-detalle").classList.add('oculto');
    }

    const inputMesSelector = document.getElementById('mesFiltro');
    if (inputMesSelector) {
      inputMesSelector.value = obtenerMesActual();
      inputMesSelector.addEventListener('change', () => cargarVentas('mes'));
    }
  </script>
</body>
</html>
